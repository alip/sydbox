CLEANFILES= syscall_marshaller.c syscall_marshaller.h gmon.out
EXTRA_DIST= syscall_marshaller.list

AM_CFLAGS= -DSYSCONFDIR=\"$(sysconfdir)\" -DGIT_HEAD=\"$(GIT_HEAD)\" \
	   $(glib_CFLAGS) $(gobject_CFLAGS) @SYDBOX_CFLAGS@
bin_PROGRAMS = sydbox
sydbox_SOURCES = children.h context.h sydbox-log.h loop.h \
		 path.h proc.h syscall.h trace.h wrappers.h \
		 sydbox-config.h sydbox-log.h sydbox-utils.h \
		 path.c proc.c children.c \
		 context.c syscall.c trace.c wrappers.c loop.c \
		 sydbox-config.c sydbox-log.c sydbox-utils.c main.c
sydbox_LDADD= $(glib_LIBS) $(gobject_LIBS)

# dispatch.c
sydbox_SOURCES+= dispatch.h dispatch-table.h
if I386
sydbox_SOURCES+= dispatch.c
endif
if X86_64
sydbox_SOURCES+= dispatch32.c dispatch64.c
endif
if IA64
sydbox_SOURCES+= dispatch.c
endif

nodist_sydbox_SOURCES= syscall_marshaller.h syscall_marshaller.c
BUILT_SOURCES= syscall_marshaller.h syscall_marshaller.c
if P1
nodist_sydbox_SOURCES+= syscallent.h
BUILT_SOURCES+= syscallent.h
CLEANFILES+= syscallent.h
if GCC
syscallent.h:
	@echo "Generating $@ from asm/unistd.h"
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
	echo '' | $(CC) $(CFLAGS) -E --include asm/unistd.h -dM - |\
		sort -n -k 3 |\
		while read line; do \
			if [ "$${line#\#define __NR_}" != "$$line" ]; then \
				no="$$(echo \"$$line\" | cut -d' ' -f2)"; \
				name="$$(echo \"$$no\" | $(SED) -e 's:__NR_::')"; \
				echo "{$$no, $$name}," >> $@ ;\
			fi \
		done
else
syscallent.h:
	@echo "Generating dummy $@ because compiler isn't gcc"
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
endif
endif
if P2
nodist_sydbox_SOURCES+= syscallent32.h syscallent64.h
BUILT_SOURCES+= syscallent32.h syscallent64.h
CLEANFILES+= syscallent32.h syscallent64.h
if GCC
syscallent32.h:
	@echo "Generating $@ from asm/unistd_32.h"
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
	echo '' | $(CC) $(CFLAGS) -E --include asm/unistd_32.h -dM - |\
		sort -n -k 3 |\
		while read line; do \
			if [ "$${line#\#define __NR_}" != "$$line" ]; then \
				no="$$(echo \"$$line\" | cut -d' ' -f2)"; \
				name="$$(echo \"$$no\" | $(SED) -e 's:__NR_::')"; \
				echo "{$$no, $$name}," >> $@ ;\
			fi \
		done
syscallent64.h:
	@echo "Generating $@ from asm/unistd_64.h"
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
	echo '' | $(CC) $(CFLAGS) -E --include asm/unistd_64.h -dM - |\
		sort -n -k 3 |\
		while read line; do \
			if [ "$${line#\#define __NR_}" != "$$line" ]; then \
				no="$$(echo \"$$line\" | cut -d' ' -f2)"; \
				name="$$(echo \"$$no\" | $(SED) -e 's:__NR_::')"; \
				echo "{$$no, $$name}," >> $@ ;\
			fi \
		done
else
syscallent32.h:
	@echo "Generating dummy $@ because compiler isn't gcc"
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
syscallent64.h:
	@echo "Generating dummy $@ because compiler isn't gcc"
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
endif
endif

syscall_marshaller.h: syscall_marshaller.list
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
	glib-genmarshal --prefix syscall_marshall --header $< >> $@
syscall_marshaller.c: syscall_marshaller.list
	echo "/* vim: set ro : */" > $@
	echo >> $@
	echo "/* ******************************************************** */" >> $@
	echo "/* THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY */" >> $@
	echo "/* ******************************************************** */" >> $@
	echo >> $@
	glib-genmarshal --prefix syscall_marshall --body $< >> $@

